<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>TW STOCK</title>
    <!-- https://electronjs.org/docs/tutorial/security#csp-meta-tag -->
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
</head>

<body>
    <label for="fname">input five stock:</label><br>
    <input type="text" id="stock1"><br>
    <input type="text" id="stock2"><br>
    <input type="text" id="stock3"><br>
    <input type="text" id="stock4"><br>
    <input type="text" id="stock5"><br>
    <input type="range" min="1" max="100" value="10" class="slider" id="myRange">
    <button id="save" onclick="saveJson()">save</button>
    <canvas id="canvas" width="100" height="100" style="display: none"></canvas>
    <script>
        const { nativeImage, ipcRenderer } = require('electron');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        // const img = new Image();
        var twseStockPrices = require('twse-stock-prices');
        const stockJson = require('./json/stock.json')
        let stocks = stockJson.stocks
        let i = 0;
        let arrStock = ['stock1', 'stock2', 'stock3', 'stock4', 'stock5']
        let arrStockPopover = ['stock1Popover', 'stock2Popover', 'stock3Popover', 'stock4Popover', 'stock5Popover']
        // 把過去的紀錄寫進去
        let j = 0;
        stocks.forEach(function (stock) {
            document.getElementById(arrStock[j]).value = stock;
            j++
        })
        let stockinfo;
        function saveJson() {
            let tmpArr = []
            for (var k = 0; k < 5; k++) {
                tmpArr.push(document.getElementById(arrStock[k]).value)
            }
            stocks = tmpArr
            updateStock(stocks)
            ipcRenderer.send('saveJson', tmpArr);
        }
        updateStock(stocks)
        //5秒鐘更新一次
        setInterval(function () { updateStock(stocks) }, 5000);
        function stockColor(yesterdayStock, price) {
            if (parseFloat(price) > parseFloat(yesterdayStock)) {
                return '#FF0000'
            } else if (parseFloat(price) < parseFloat(yesterdayStock)) {
                return '#00DB00'
            } else {
                return 'white'
            }
        }
        function stockPercent(stock) {
            var num = (parseFloat(stock.price) - parseFloat(stock.y)) / parseFloat(stock.y) * 100
            num = num.toFixed(2);
            // console.log(num)
            return num
        }
        function createStockImg(stockObject, stockElement) {
            const img = new Image();
            img.src = './img/empty.png'
            img.onload = () => {
                canvas.width = 120;
                canvas.height = 30;
                ctx.imageSmoothingQuality = 'high';
                ctx.font = "12px Roboto";
                ctx.fillStyle = 'white';
                ctx.fillText(stockObject.c + stockObject.n, 0, 11);
                ctx.font = "600 16px Roboto";
                ctx.fillStyle = stockColor(stockObject.y, stockObject.price);
                ctx.fillText(stockObject.price + ' (' + stockPercent(stockObject) + '%)', 0, 29);
                const data = canvas.toDataURL('image/png', 1);
                const image = nativeImage.createFromDataURL(data).toPNG();
                ipcRenderer.send(stockElement, image);
            }
        }
        function createStockPopoverImg(stockObject, stockElement) {
            const img = new Image();
            img.src = './img/empty.png'
            img.onload = () => {
                canvas.width = 300;
                canvas.height = 30;
                ctx.imageSmoothingQuality = 'high';
                ctx.font = "12px Roboto";
                ctx.fillStyle = 'white';
                ctx.fillText('昨收', 0, 11);
                ctx.fillText('開盤', 60, 11);
                ctx.fillText('最高', 120, 11);
                ctx.fillText('最低', 180, 11);
                ctx.fillText('成交量', 240, 11);
                ctx.font = "600 16px Roboto";
                ctx.fillText(stockObject.y.toString().substring(0, stockObject.y.toString().length - 2), 0, 29);
                ctx.fillText(stockObject.v.toString().substring(0, stockObject.o.toString().length - 2), 240, 29);

                ctx.fillStyle = stockColor(stockObject.y, stockObject.o);
                ctx.fillText(stockObject.o.toString().substring(0, stockObject.o.toString().length - 2), 60, 29);
                ctx.fillStyle = stockColor(stockObject.y, stockObject.h);
                ctx.fillText(stockObject.h.toString().substring(0, stockObject.h.toString().length - 2), 120, 29);
                ctx.fillStyle = stockColor(stockObject.y, stockObject.l);
                ctx.fillText(stockObject.l.toString().substring(0, stockObject.l.toString().length - 2), 180, 29);

                const data = canvas.toDataURL('image/png', 1);
                const image = nativeImage.createFromDataURL(data).toPNG();
                ipcRenderer.send(stockElement, image);
            }
        }
        function updateStock(stocks) {
            twseStockPrices.getCurrentPrice(stocks, function (err, result) {
                let stockObjects = result.msgArray
                let i = 0
                stockObjects.forEach(function (stockObject) {
                    // ['股票代號','公司簡稱','當盤成交價','當盤成交量','累積成交量','開盤價','最高價','最低價','昨收價']
                    // ['c','n','z','tv','v','o','h','l','y']
                    // '股票代號','公司簡稱','當盤成交價' (漲跌用紅綠表示)
                    if (stockObject.z !== '-') {
                        stockObject.price = stockObject.z.toString()
                    } else {
                        stockObject.price = stockObject.b.substring(0, stockObject.b.indexOf('_'));
                    }
                    stockObject.price = stockObject.price.substring(0, stockObject.price.length - 2);
                    createStockImg(stockObject, arrStock[i])
                    createStockPopoverImg(stockObject, arrStockPopover[i])
                    i++
                })
            });
        }

    </script>
</body>

</html>